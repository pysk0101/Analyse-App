<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AYT Sayısal Net Hesaplama</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body
    class="bg-gradient-to-br from-purple-900 to-indigo-900 text-white min-h-screen flex items-center justify-center p-4">
    <div class="container max-w-4xl mx-auto p-8 bg-white/10 backdrop-blur-lg rounded-xl shadow-lg">
        <h1 class="text-3xl font-bold mb-6 text-center">AYT Sayısal Net Hesaplama</h1>
        <form id="netHesaplamaForm" action="/calculation/aytSay" method="POST">
            <table class="w-full mb-6">
                <thead>
                    <tr class="border-b border-white/20">
                        <th class="text-left py-2">Ders</th>
                        <th class="text-center py-2">Doğru</th>
                        <th class="text-center py-2">Yanlış</th>
                        <th class="text-center py-2">Net</th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="border-b border-white/10">
                        <td class="py-2">Matematik</td>
                        <td><input type="number" name="math[true]"
                                class="w-full bg-white/10 border border-white/20 rounded-md px-3 py-2 text-white"
                                min="0"></td>
                        <td><input type="number" name="math[false]"
                                class="w-full bg-white/10 border border-white/20 rounded-md px-3 py-2 text-white"
                                min="0"></td>
                        <td class="text-center net-sonuc">0</td>
                    </tr>
                    <tr class="border-b border-white/10">
                        <td class="py-2">Fizik</td>
                        <td><input type="number" name="physics[true]"
                                class="w-full bg-white/10 border border-white/20 rounded-md px-3 py-2 text-white"
                                min="0"></td>
                        <td><input type="number" name="physics[false]"
                                class="w-full bg-white/10 border border-white/20 rounded-md px-3 py-2 text-white"
                                min="0"></td>
                        <td class="text-center net-sonuc">0</td>
                    </tr>
                    <tr class="border-b border-white/10">
                        <td class="py-2">Kimya</td>
                        <td><input type="number" name="chemistry[true]"
                                class="w-full bg-white/10 border border-white/20 rounded-md px-3 py-2 text-white"
                                min="0"></td>
                        <td><input type="number" name="chemistry[false]"
                                class="w-full bg-white/10 border border-white/20 rounded-md px-3 py-2 text-white"
                                min="0"></td>
                        <td class="text-center net-sonuc">0</td>
                    </tr>
                    <tr class="border-b border-white/10">
                        <td class="py-2">Biyoloji</td>
                        <td><input type="number" name="biology[true]"
                                class="w-full bg-white/10 border border-white/20 rounded-md px-3 py-2 text-white"
                                min="0"></td>
                        <td><input type="number" name="biology[false]"
                                class="w-full bg-white/10 border border-white/20 rounded-md px-3 py-2 text-white"
                                min="0"></td>
                        <td class="text-center net-sonuc">0</td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr class="font-bold">
                        <td class="py-2">Toplam</td>
                        <td id="toplam_dogru" class="text-center">0</td>
                        <td id="toplam_yanlis" class="text-center">0</td>
                        <td id="toplam_net" class="text-center">0</td>
                    </tr>
                </tfoot>
            </table>
            <div class="flex justify-center space-x-4">
                <input type="text" name="examName" placeholder="Deneme ismini giriniz"
                    class="px-6 py-2 rounded-lg font-semibold transition text-slate-500">
                <button type="button" id="sifirlaBtn"
                    class="px-6 py-2 bg-red-500 hover:bg-red-600 rounded-lg font-semibold transition">Sıfırla</button>
                <button type="button" id="hesaplaBtn"
                    class="px-6 py-2 bg-green-500 hover:bg-green-600 rounded-lg font-semibold transition">Hesapla</button>
                <button type="submit"
                    class="px-6 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg font-semibold transition">Kaydet
                </button>
            </div>
        </form>
    </div>
    <script>
        var userEJS = '<%- JSON.stringify(user) %>'
    </script>

    <script>
        const user = JSON.parse(userEJS);

        const form = document.getElementById('netHesaplamaForm');
        const netSonuclar = document.querySelectorAll('.net-sonuc');
        const toplamDogru = document.getElementById('toplam_dogru');
        const toplamYanlis = document.getElementById('toplam_yanlis');
        const toplamNet = document.getElementById('toplam_net');
        const hesaplaBtn = document.getElementById('hesaplaBtn');
        const sifirlaBtn = document.getElementById('sifirlaBtn');

        function hesaplaNet() {
            let toplamD = 0, toplamY = 0, toplamN = 0;
            const dersler = ['math', 'physics', 'chemistry', 'biology'];

            dersler.forEach((ders, index) => {
                const dogru = parseInt(form[`${ders}[true]`].value) || 0;
                const yanlis = parseInt(form[`${ders}[false]`].value) || 0;
                const net = dogru - (yanlis * 0.25);

                netSonuclar[index].textContent = net.toFixed(2);
                toplamD += dogru;
                toplamY += yanlis;
                toplamN += net;
            });

            toplamDogru.textContent = toplamD;
            toplamYanlis.textContent = toplamY;
            toplamNet.textContent = toplamN.toFixed(2);
        }

        function sifirla() {
            form.reset();
            netSonuclar.forEach(el => el.textContent = '0');
            toplamDogru.textContent = '0';
            toplamYanlis.textContent = '0';
            toplamNet.textContent = '0';
        }

        async function gonderForm(e) {
            try {
                e.preventDefault();
                hesaplaNet();

                const formData = new FormData(form);
                const data = {
                    userId: user._id,
                    examField: "ayt",
                    aytField :"say",
                    examName: formData.get('examName'),
                    correctAnswers: parseInt(toplamDogru.textContent),
                    wrongAnswers: parseInt(toplamYanlis.textContent),
                    emptyAnswers: 80 - (parseInt(toplamDogru.textContent) + parseInt(toplamYanlis.textContent)),
                    totalNet: parseFloat(toplamNet.textContent),
                    solvingSpan: 180, // AYT için süre 180 dakika
                };

                ['math', 'physics', 'chemistry', 'biology'].forEach(ders => {
                    const dogru = parseInt(formData.get(`${ders}[true]`)) || 0;
                    const yanlis = parseInt(formData.get(`${ders}[false]`)) || 0;
                    data[ders] = {
                        true: dogru,
                        false: yanlis,
                        emptyAnswers: 20 - (dogru + yanlis), // Her ders için 20 soru olduğunu varsayıyoruz
                        totalNet: dogru - (yanlis * 0.25)
                    };
                });

                const response = await fetch('/calculation/aytSay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data),
                })

                if (!response.ok) throw new Error('Ayt oluşturulamadı.');
                alert("Deneme başarı ile kaydedildi");
                const result = await response.json();

                if (result.success && result.redirectUrl) {
                    window.location.href = result.redirectUrl;
                }

            } catch (error) {
                console.log(error)
            }
        }

        hesaplaBtn.addEventListener('click', hesaplaNet);
        sifirlaBtn.addEventListener('click', sifirla);
        form.addEventListener('submit', gonderForm);
    </script>
</body>

</html>